name: Release Windows EXE

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller uiautomation

      - name: Build UIA EXE
        shell: pwsh
        run: |
          $uiaBin = @'
          import pathlib
          import uiautomation
          print(pathlib.Path(uiautomation.__file__).resolve().parent / "bin")
          '@ | python -
          $uiaBin = $uiaBin.Trim()

          $uiaX64 = Join-Path $uiaBin "UIAutomationClient_VC140_X64.dll"
          $uiaX86 = Join-Path $uiaBin "UIAutomationClient_VC140_X86.dll"
          if (-not (Test-Path $uiaX64) -or -not (Test-Path $uiaX86)) {
            throw "UI Automation DLLs not found in $uiaBin"
          }

          python -m PyInstaller `
            --noconfirm `
            --onefile `
            --windowed `
            --name tts-reader-uia `
            --hidden-import uiautomation `
            --collect-all uiautomation `
            --add-binary "$uiaX64;uiautomation\bin" `
            --add-binary "$uiaX86;uiautomation\bin" `
            src\main.py

      - name: Generate SHA256
        shell: pwsh
        run: |
          $hash = (Get-FileHash dist\tts-reader-uia.exe -Algorithm SHA256).Hash.ToLower()
          "$hash  tts-reader-uia.exe" | Out-File dist\SHA256SUMS.txt -Encoding ascii

      - name: Publish Release Assets
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/tts-reader-uia.exe
            dist/SHA256SUMS.txt
