# TTS Reader 体积分析与瘦身优化方案

目前无论是 `tts-reader.exe` 还是带 UI 增强的 `tts-reader-uia.exe`，打包后的单文件体积可能都偏大（通常在 60MB - 100MB 之间）。对于一个只用来“选词发声”和“截图发声”的长驻小工具来说，这个体积显得有些臃肿。

以下是对其体积构成原因的拆解，以及可落地的瘦身建议。

---

## 1. 现状：体积都花在哪了？

程序使用 `PyInstaller` 将所有的环境和依赖打包成一个独立的 `.exe`。解剖这个 Exe，体积大头主要来源于以下三个方面：

1. **AI 图像识别引擎及其附带文件（占比最大，约 50% - 60%）**
   - 当前项目引入了 `rapidocr-onnxruntime` 来实现截图文字识别。
   - 这不仅带入了 `onnxruntime`（微软的深度学习推理库，C++ 动态链接库很大），还附带了 `Numpy`（庞大的科学计算基础库），以及三个体积不小的 AI 模型（文字检测、方向分类、文字识别）。
2. **Python 解释器与标准库（占比约 20% - 30%）**
   - 为了让没有任何 Python 环境的普通用户做到“开箱即用”，PyInstaller 把整个 Python 的运行环境（`python3x.dll` 等）和所有用到的基础模块（如 `email`, `xml`, `ssl` 等，即使本项目用不到）都塞了进去。
3. **图形界面与自动化控制库（占比约 10%）**
   - 当前控制面板依赖的 `tkinter` 库底层绑定了 Tcl/Tk 图形引擎（一堆 .dll 和无用的样式贴图）。
   - `uiautomation` 为了实现深度的系统控件穿透，带入了多个 C++ 编译的底层拦截 DLL。

---

## 2. 优化方案：如何给软件“抽脂”？

按照**推荐程度和立竿见影的效果**排序：

### 方案 A：使用 Windows 原生 OCR 替代本地 AI 模型（终极瘦身，推荐度：⭐⭐⭐⭐⭐）
- **做法**：废弃庞大的 `rapidocr-onnxruntime` 和 `Numpy`。从 Windows 10 开始，系统底层实际上内置了非常强大的 `Windows.Media.Ocr` API，原生支持离线中英文识别。可以通过 Python 的 `winsdk` 库直接调用这个系统级接口。
- **收益**：**体积直接砍掉 40MB-50MB！** 零模型、零 Numpy，纯调用系统能力。同时，因为是调用 C# 底层 API，第一阶段提到的“3秒延迟”问题中，OCR 的几百毫秒耗时也会被压缩到极致，可谓一石二鸟。 

### 方案 B：依赖隔离与纯净打包（基操瘦身，推荐度：⭐⭐⭐⭐）
- **做法**：
  1. 很多时候开发者打包时，虚拟环境（`.venv`）里装了各种测试工具包（比如 `pytest`, `pip`, `setuptools` 等），这会导致这些多余的东西被误打包。
  2. 在打包脚本运行前，创建一个**绝对纯净**的临时虚拟环境，严格只 `pip install -r requirements.txt`。
  3. 在 `tts-reader-uia.spec` 文件的 `excludes=[]` 列表中，显式填入本项目没用到的无用庞大库，如 `['email', 'xml', 'html', 'http', 'unittest']`。
- **收益**：可以减小 5MB - 10MB 的体积浪费。

### 方案 C：使用 UPX 深度压缩（物理瘦身，推荐度：⭐⭐⭐）
- **做法**：目前的打包配置 `tts-reader-uia.spec` 中虽然写了 `upx=True`，但如果开发者的电脑上没有下载安装 [UPX (Ultimate Packer for eXecutables)](https://upx.github.io/) 这个工具并放入系统环境变量，这条指令是会静默失效的。
- **要求研发人员**：下载 `upx.exe` 放进项目的根目录，重新进行打包编译。
- **收益**：程序的原始体积将被高强度压缩 30% - 50%。缺点是每次用户双击运行程序时，会在内存里实时解压，导致启动速度慢 0.5 秒左右（对于常驻后台工具来说，这几乎无感，非常适合）。

### 方案 D：界面替换策略（远期瘦身，推荐度：⭐⭐）
- **做法**：如前一章节提到的 UI 优化，如果未来追求极致原生的体积，甚至可以抛弃 Python 自带的 `tkinter`，转而使用 `win32gui`（几百 KB）手写一个极简的系统托盘菜单，设置面板直接唤起一个简单的 `.ini` 或 `.json` 记事本让用户编辑，主打极简挂机工具。
- **收益**：砍掉整个 Tkinter 引擎（省约 8MB），回归工具最本质的面貌。

---

## 3. 给开发者的行动清单

如果你希望立刻缩小体积，请研发按下述顺序执行：
1. **短期可行**：部署 UPX 并在纯净环境下打包，调整 `spec` 文件的 excludes 排除列表。预计可压制到 30MB 左右。
2. **彻底解决**：调研并切换至 `Windows.Media.Ocr`（依赖 `winsdk`），剔除 `rapidocr`。实施后安装包有望降至 15MB 左右，成为真正的轻便且极速的小工具。
